---
- name: Access Key
  hosts: localhost
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tags: always
  tasks:
      - name: Access Key | Write SSH Private Key
        ansible.builtin.copy:
            content: "{{ cs_vm_ssh_priv_id_ecdsa_b64 | b64decode
                | get_unencrypted_id_ecdsa(password=cs_vm_ssh_priv_id_ecdsa_password) }}"
            mode: "0600"
            dest: "{{ cs_vm_ssh_local_key_file }}"

- name: Mini0
  hosts: localhost
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tags: never,mini0
  tasks:
      - name: Get BWS Secret
        ansible.builtin.import_tasks:
            file: tasks/secrets.yml
      - name: Mini0
        ansible.builtin.import_tasks:
            file: tasks/minio.yml

- name: Patch Cloud System
  hosts: patchservers
  become: true
  become_user: root
  gather_facts: true
  no_log: "{{ cs_no_log }}"
  tags: never,patch
  tasks:
      - name: Patch Cloud System
        ansible.builtin.import_tasks:
            file: tasks/patch.yml

- name: Database
  hosts: rb4-m1
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tasks:
      - name: Database | Postgres
        become: true
        become_user: root
        tags: never,database,postgres
        ansible.builtin.import_tasks:
            file: tasks/postgres.yml

      - name: Database | Redis
        become: true
        become_user: root
        tags: never,database,redis
        ansible.builtin.import_tasks:
            file: tasks/redis.yml

      - name: Database | Elasticsearch
        become: true
        become_user: root
        tags: never,database,elasticsearch
        ansible.builtin.import_tasks:
            file: tasks/elasticsearch.yml

- name: OnlyOffice
  hosts: rb4-m2
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tasks:
      - name: OnlyOffice
        tags: never,onlyoffice
        become: true
        become_user: root
        ansible.builtin.import_tasks:
            file: tasks/onlyoffice.yml

- name: Nextcloud
  hosts: rb4-m3
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tasks:
      - name: Calculate Nextcloud Protocol cs_nc_protocol
        tags: never,nextcloud,nextcloud_prepare,nextcloud_install,nextcloud_hub_bundle
        ansible.builtin.set_fact:
            cs_nc_protocol: "{{ (cs_nc_full_chain_b64 is defined and cs_nc_priv_key_b64 is defined)
                | ternary('https', 'http') }}"

      - name: Nextcloud | Test cs_nc_protocol
        tags: never,nextcloud,nextcloud_prepare,nextcloud_install,nextcloud_hub_bundle
        ansible.builtin.assert:
            that:
                - "cs_nc_protocol in ['http', 'https']"
            fail_msg: "cs_nc_protocol must be either 'http' or 'https'"
            success_msg: "cs_nc_protocol is valid"

      - name: Nextcloud | Prepare
        tags: never,nextcloud,nextcloud_prepare
        become: true
        become_user: root
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/prepare.yml

      - name: Nextcloud | Mount Disk
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_mount
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/mount.yml

      - name: Nextcloud | Install
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_install
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/install.yml

      - name: Nextcloud | Admin
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_admin
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/admin.yml

      - name: Nextcloud | Cache
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_cache
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/cache.yml

      - name: Nextcloud | Imaginary
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_imaginary
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/imaginary.yml

      - name: Nextcloud | Full Text Search
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_fulltextsearch
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/fulltextsearch.yml

      - name: Nextcloud | OnlyOffice
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_onlyoffice
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/onlyoffice.yml

      - name: Nextcloud | Hub Bundle
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_hub_bundle
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/hub_bundle.yml

      - name: Nextcloud | Post Install
        become: true
        become_user: root
        tags: never,nextcloud,nextcloud_post_install
        ansible.builtin.import_tasks:
            file: tasks/nextcloud/post-install.yml

- name: Delete all
  hosts: patchservers
  become: false
  gather_facts: false
  no_log: "{{ cs_no_log }}"
  tasks:
      - name: Delete all
        become: true
        become_user: root
        tags: never,delete_all
        ansible.builtin.shell:
            cmd: |+
                docker rm -v -f $(docker ps -qa)
                docker system prune -af --volumes
                apt-get clean
                apt-get autoremove -y
                apt autopurge -y apache2* php*
                rm -rf /app /etc/php /etc/apache2 /run/apache2 /run/php
        changed_when: true
        register: delete_all

      - name: Delete all | Debug
        ansible.builtin.debug:
            var: delete_all
