---
- name: OnlyOffice | Stop old container
  community.docker.docker_container:
      name: onlyoffice-main
      state: absent
      force_kill: true

- name: OnlyOffice | Create directories
  ansible.builtin.file:
      path: "{{ item }}"
      state: directory
      mode: "0755"
  with_items:
      - "{{ cs_onlyoffice_dir }}/data"
      - "{{ cs_onlyoffice_dir }}/logs"
      - "{{ cs_onlyoffice_dir }}/lib"
      - "{{ cs_onlyoffice_dir }}/db"
      - "/etc/ssl/{{ cs_onlyoffice_domain }}"

- name: OnlyOffice | Create SSL Private key
  community.crypto.openssl_privatekey:
      path: "/etc/ssl/{{ cs_onlyoffice_domain }}/privkey.pem"
      size: 4096
      mode: "0600"

- name: OnlyOffice | Create SSL CSR
  community.crypto.openssl_csr:
      path: "/tmp/onlyoffice-server.csr"
      privatekey_path: "/etc/ssl/{{ cs_onlyoffice_domain }}/privkey.pem"
      common_name: "{{ cs_onlyoffice_domain }}"
      subject_alt_name:
          - "DNS:{{ cs_onlyoffice_domain }}"
      key_usage:
          - "digitalSignature"
          - "keyEncipherment"
          - "keyAgreement"
      extended_key_usage:
          - "serverAuth"
      create_subject_key_identifier: true
      mode: "0644"

- name: OnlyOffice | Sign SSL CSR
  community.crypto.x509_certificate:
      path: "/tmp/server.crt"
      csr_path: "/tmp/onlyoffice-server.csr"
      provider: ownca
      ownca_privatekey_content: "{{ lookup('ansible.builtin.file', cs_root_ca_privkey_pem_file,
          lstrip=false, rstrip=false) }}"
      ownca_privatekey_passphrase: "{{ lookup('ansible.builtin.file', cs_root_ca_privkey_pass_file,
          lstrip=false, rstrip=false) }}"
      ownca_content: "{{ lookup('ansible.builtin.file', cs_root_ca_cert_pem_file,
          lstrip=false, rstrip=false) }}"
      mode: "0644"
      return_content: true
  register: cs_onlyoffice_ssl_cert

- name: OnlyOffice | Write Full chain
  ansible.builtin.copy:
      content: |+
          {{ cs_onlyoffice_ssl_cert.certificate | trim }}
          {{ lookup('ansible.builtin.file', cs_root_ca_cert_pem_file, lstrip=false, rstrip=false) }}
      dest: "/etc/ssl/{{ cs_onlyoffice_domain }}/fullchain.pem"
      mode: "0644"

- name: OnlyOffice | Start Container
  community.docker.docker_container:
      name: onlyoffice-main
      image: "docker.io/onlyoffice/documentserver:8.1.1.1"
      volumes:
          - "{{ cs_onlyoffice_dir }}/data:/var/www/onlyoffice/Data"
          - "{{ cs_onlyoffice_dir }}/logs:/var/log/onlyoffice"
          - "{{ cs_onlyoffice_dir }}/lib:/var/lib/onlyoffice"
          - "{{ cs_onlyoffice_dir }}/db:/var/lib/postgresql"
          - "/etc/ssl/{{ cs_onlyoffice_domain }}/fullchain.pem:/cert.pem:ro"
          - "/etc/ssl/{{ cs_onlyoffice_domain }}/privkey.pem:/priv.key:ro"
      state: started
      ports:
          - "{{ cs_onlyoffice_port }}:443"
      restart_policy: unless-stopped
      env:
          JWT_SECRET: "{{ cs_onlyoffice_jwt_secret }}"
          SSL_KEY_PATH: "/priv.key"
          SSL_CERTIFICATE_PATH: "/cert.pem"
          WOPI_ENABLED: "true"
          GENERATE_FONTS: "true"

- name: OnlyOffice | Enable UFW port
  community.general.ufw:
      rule: allow
      port: "{{ item }}"
      state: enabled
  with_items:
      - "{{ cs_onlyoffice_port }}"

- name: OnlyOffice | Wait for service to start
  ansible.builtin.uri:
      url: "https://{{ cs_onlyoffice_domain }}:{{ cs_onlyoffice_port }}/healthcheck"
      method: GET
      status_code: 200
      return_content: true
      ca_path: "/etc/ssl/{{ cs_onlyoffice_domain }}/fullchain.pem"
      validate_certs: true
  register: is_onlyoffice_up
  until: is_onlyoffice_up.status == 200
  retries: 30
  delay: 3

- name: OnlyOffice | Enable example document server
  community.docker.docker_container_exec:
      container: onlyoffice-main
      command: sudo supervisorctl start ds:example
  register: onlyoffice_example
  changed_when: true

- name: OnlyOffice | Debug example document server
  ansible.builtin.debug:
      var: onlyoffice_example

- name: OnlyOffice | Add to auto start
  community.docker.docker_container_exec:
      container: onlyoffice-main
      command: sudo sed 's,autostart=false,autostart=true,' -i /etc/supervisor/conf.d/ds-example.conf
  register: onlyoffice_autostart

- name: OnlyOffice | Debug auto start
  ansible.builtin.debug:
      var: onlyoffice_autostart
