---
- name: Mini0 | Mini0 | Create group
  become: true
  become_user: root
  ansible.builtin.group:
      name: "{{ pv_cs_minio_server_group_name }}"
      state: present
      system: true
  register: minio_server_group_name_create

- name: Mini0 | Mini0 | Create User
  become: true
  become_user: root
  ansible.builtin.user:
      name: "{{ pv_cs_minio_server_user_name }}"
      group: "{{ pv_cs_minio_server_group_name }}"
      groups:
          - docker
      shell: /bin/false
      system: true
      state: present
  register: minio_server_user_name_create

- name: Mini0 | Mini0 | Create Directory
  become: true
  become_user: root
  ansible.builtin.file:
      name: "{{ item }}"
      owner: "{{ pv_cs_minio_server_user_name }}"
      group: "{{ pv_cs_minio_server_group_name }}"
      mode: "0755"
      state: directory
  with_items:
      - "{{ pv_cs_minio_server_working_dir }}"
      - "{{ pv_cs_minio_server_volume_dir }}"
      - "{{ pv_cs_minio_server_certs_dir }}"

- name: Mini0 | Mini0 | Docker Network
  become: true
  become_user: root
  community.docker.docker_network:
      name: "{{ pv_cs_minio_docker_network_name }}"
      state: present

- name: Mini0 | Mini0 | Remove old Container
  become: true
  become_user: root
  community.docker.docker_container:
      name: "{{ pv_cs_minio_server_container_name }}"
      state: absent
      force_kill: true

- name: Mini0 | Mini0 | Copy Kes Certs
  become: true
  become_user: root
  ansible.builtin.copy:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      owner: "{{ pv_cs_minio_server_user_name }}"
      group: "{{ pv_cs_minio_server_group_name }}"
      mode: "0644"
      remote_src: true
  with_items:
      - { src: "{{ pv_cs_minio_kes_cert_file }}", dest: "{{ pv_cs_minio_server_kes_admin_cert }}" }
      - { src: "{{ pv_cs_minio_kes_cert_key_file }}", dest: "{{ pv_cs_minio_server_kes_admin_key }}" }
      - { src: "{{ pv_cs_minio_kes_cert_file }}", dest: "{{ pv_cs_minio_server_kes_ca_cert }}" }

- name: Mini0 | Mini0 | ACME
  block:
      - name: Mini0 | Mini0 | ACME | Register ACME Account
        community.crypto.acme_account:
            account_key_content: "{{ pv_cs_acme_account_key_base64 | ansible.builtin.b64decode }}"
            acme_directory: "https://acme-v02.api.letsencrypt.org/directory"
            acme_version: 2
            state: present
            terms_agreed: true
            contact:
                - "mailto:{{ pv_cs_contact_email_id }}"

      - name: Mini0 | Mini0 | ACME | Mini0 Server Private Key
        become: true
        become_user: root
        community.crypto.openssl_privatekey:
            path: "{{ pv_cs_minio_server_certs_dir }}/private.key"
            type: RSA
            mode: "0600"
            owner: "{{ pv_cs_minio_server_user_name }}"
            group: "{{ pv_cs_minio_server_group_name }}"

      - name: Mini0 | Mini0 | ACME | Mini0 CSR for ACME Challenge
        become: true
        become_user: root
        community.crypto.openssl_csr:
            path: "{{ pv_cs_minio_server_certs_dir }}/acme.csr"
            privatekey_path: "{{ pv_cs_minio_server_certs_dir }}/private.key"
            common_name: "{{ pv_cs_minio_server_domain }}"
            subject_alt_name:
                - "DNS:{{ pv_cs_minio_server_domain }}"
            mode: "0600"
            owner: "{{ pv_cs_minio_server_user_name }}"
            group: "{{ pv_cs_minio_server_group_name }}"
        register: minio_acme_csr_create

      - name: Mini0 | Mini0 | ACME | Delete old fullchain # noqa: no-handler
        become: true
        become_user: root
        when: minio_acme_csr_create.changed
        ansible.builtin.file:
            path: "{{ pv_cs_minio_server_certs_dir }}/fullchain.pem"
            state: absent

      - name: Mini0 | Mini0 | ACME | Create a challenge for Mini0 Domain
        become: true
        become_user: "{{ pv_cs_minio_server_user_name }}"
        community.crypto.acme_certificate:
            modify_account: false
            validate_certs: true
            deactivate_authzs: true
            acme_directory: "https://acme-v02.api.letsencrypt.org/directory"
            acme_version: 2
            csr: "{{ pv_cs_minio_server_certs_dir }}/acme.csr"
            account_email: "{{ pv_cs_contact_email_id }}"
            account_key_content: "{{ pv_cs_acme_account_key_base64 | ansible.builtin.b64decode }}"
            fullchain_dest: "{{ pv_cs_minio_server_certs_dir }}/fullchain.pem"
            terms_agreed: true
            remaining_days: 10
            challenge: dns-01
            force: false
        register: minio_acme_domain_challange

      - name: Mini0 | Mini0 | ACME | Set TXT Record Value # noqa: no-handler
        ansible.builtin.set_fact:
            # dns_txt_record_value: "{{ minio_acme_domain_challange.challenge_data[pv_cs_minio_server_domain]['dns-01']\
            #  .resource_value
            #     | community.dns.quote_txt(always_quote=true) }}" # This is the original line for amazon route 53

            dns_txt_record_value: "{{ minio_acme_domain_challange.challenge_data[pv_cs_minio_server_domain]['dns-01']\
                .resource_value }}"
        when: >
            minio_acme_domain_challange['challenge_data'] is defined
            and
            minio_acme_domain_challange['challenge_data'] | length > 0
            and
            minio_acme_domain_challange.changed

      - name: Mini0 | Mini0 | ACME | Create an A record for ACME challenge in Linode # noqa: no-handler
        when: dns_txt_record_value is defined
        delegate_to: localhost
        become: false
        linode.cloud.domain_record:
            domain: "{{ pv_cs_linode_managed_domain }}"
            name: "{{ minio_acme_domain_challange.challenge_data[pv_cs_minio_server_domain]['dns-01'].record }}"
            type: "TXT"
            ttl_sec: 30
            target: "{{ dns_txt_record_value }}"
            state: present
            api_token: "{{ pv_cs_linode_api_token }}"
        register: linode_acme_challenge_record_create

      # - name: Mini0 | Mini0 | ACME | Wait for DNS to propagate
      #   delegate_to: localhost
      #   community.dns.wait_for_txt:
      #       timeout: 300
      #       query_retry: 5
      #       query_timeout: 5
      #       max_sleep: 5
      #       records:
      #           - name: "{{ minio_acme_domain_challange.challenge_data[pv_cs_minio_server_domain]['dns-01'].record }}"
      #             values: "{{ dns_txt_record_value }}"
      #             mode: equals

      - name: Mini0 | Mini0 | ACME | Wait for DNS to propagate # noqa: no-handler
        when: >
            minio_acme_domain_challange.changed
            and
            (linode_acme_challenge_record_create.skipped is not defined
            or
            not linode_acme_challenge_record_create.skipped)
        delegate_to: localhost
        become: false
        ansible.builtin.set_fact:
            dns_record_value_propagated: "{{ lookup('community.general.dig',
                minio_acme_domain_challange.challenge_data[pv_cs_minio_server_domain]['dns-01'].record, qtype='TXT') }}"
        register: wait_for_dns_propagation
        until: dns_txt_record_value in wait_for_dns_propagation.ansible_facts.dns_record_value_propagated
        retries: 10
        delay: 5
        ignore_errors: true

      - name: Mini0 | Mini0 | ACME | Let the challenge be validated and retrieve the cert and intermediate certificate
        when: minio_acme_domain_challange.changed # noqa: no-handler
        become: true
        become_user: "{{ pv_cs_minio_server_user_name }}"
        community.crypto.acme_certificate:
            acme_directory: "https://acme-v02.api.letsencrypt.org/directory"
            acme_version: 2
            csr: "{{ pv_cs_minio_server_certs_dir }}/acme.csr"
            account_email: "{{ pv_cs_contact_email_id }}"
            account_key_content: "{{ pv_cs_acme_account_key_base64 | ansible.builtin.b64decode }}"
            fullchain_dest: "{{ pv_cs_minio_server_certs_dir }}/fullchain.pem"
            terms_agreed: true
            remaining_days: 10
            challenge: dns-01
            data: "{{ minio_acme_domain_challange }}"

      - name: Mini0 | Mini0 | ACME | Remove the challenge record from Linode # noqa: no-handler
        # when: >
        #   linode_acme_challenge_record_create.skipped is not defined
        #   or
        #   not linode_acme_challenge_record_create.skipped
        when: false # This record is useful in case i need to force the certificate regeneration
        delegate_to: localhost
        linode.cloud.domain_record:
            domain: "{{ pv_cs_linode_managed_domain }}"
            record_id: "{{ linode_acme_challenge_record_create.record.id }}"
            state: absent
            api_token: "{{ pv_cs_linode_api_token }}"

- name: Mini0 | Mini0 | Copy fullchain to public.crt
  become: true
  become_user: root
  ansible.builtin.copy:
      src: "{{ pv_cs_minio_server_certs_dir }}/fullchain.pem"
      dest: "{{ pv_cs_minio_server_certs_dir }}/public.crt"
      owner: "{{ pv_cs_minio_server_user_name }}"
      group: "{{ pv_cs_minio_server_group_name }}"
      remote_src: true
      mode: "0644"

- name: Mini0 | Mini0 | Start Container
  become: true
  become_user: "{{ pv_cs_minio_server_user_name }}"
  community.docker.docker_container:
      name: "{{ pv_cs_minio_server_container_name }}"
      image: "{{ pv_cs_minio_server_image }}:{{ pv_cs_minio_server_version }}"
      restart_policy: unless-stopped
      hostname: "{{ pv_cs_minio_server_domain }}"
      user: "{{ minio_server_user_name_create.uid }}:{{ minio_server_group_name_create.gid }}"
      ports:
          - "{{ pv_cs_minio_server_port }}:{{ pv_cs_minio_server_port }}"
          - "{{ pv_cs_minio_server_console_port }}:{{ pv_cs_minio_server_console_port }}"
      volumes:
          - "{{ pv_cs_minio_server_working_dir }}:{{ pv_cs_minio_server_working_dir }}"
      networks:
          - name: "{{ pv_cs_minio_docker_network_name }}"
      env:
          MINIO_KMS_KES_ENDPOINT: "{{ pv_cs_minio_server_kes_endpoint }}"
          MINIO_KMS_KES_KEY_FILE: "{{ pv_cs_minio_server_kes_admin_key }}"
          MINIO_KMS_KES_CERT_FILE: "{{ pv_cs_minio_server_kes_admin_cert }}"
          MINIO_KMS_KES_CAPATH: "{{ pv_cs_minio_server_kes_ca_cert }}"
          MINIO_KMS_KES_KEY_NAME: "{{ pv_cs_minio_server_default_kms_key_id }}"
          MINIO_ROOT_USER: "{{ pv_cs_minio_server_root_user }}"
          MINIO_ROOT_PASSWORD: "{{ pv_cs_minio_server_root_password }}"
          MINIO_REGION: "{{ pv_cs_minio_server_region }}"
      command:
          - server
          - "{{ pv_cs_minio_server_volume_dir }}"
          - --address
          - "{{ pv_cs_minio_server_domain }}:{{ pv_cs_minio_server_port }}"
          - --console-address
          - "{{ pv_cs_minio_server_domain }}:{{ pv_cs_minio_server_console_port }}"
          - --certs-dir
          - "{{ pv_cs_minio_server_certs_dir }}"

- name: Mini0 | Mini0 | Enable UFW
  become: true
  become_user: root
  community.general.ufw:
      rule: allow
      port: "{{ item }}"
      proto: tcp
      comment: "Allow Minio Server"
      state: enabled
  with_items:
      - "{{ pv_cs_minio_server_port }}"
      - "{{ pv_cs_minio_server_console_port }}"
