---
- name: Mini0 | Disk | Gather facts
  become: true
  ansible.builtin.setup:
  delegate_to: cs-minio-linode-host
  retries: 3 # Because wait for the instance to boot
  delay: 5

- name: Mini0 | Disk | Get Volume Info
  delegate_to: localhost
  become: false
  linode.cloud.volume_info:
      label: "{{ pv_cs_minio_linode_volume_label }}"
      api_token: "{{ pv_cs_linode_api_token }}"
  register: minio_existing_linode_volume_info

- name: Mini0 | Disk | Remove mount
  become: true
  ansible.posix.mount:
      path: "{{ pv_cs_minio_linode_volume_mount_path }}"
      src: "{{ minio_existing_linode_volume_info.volume.filesystem_path }}"
      state: absent

- name: Mini0 | Disk | Remove all fstab entries
  become: true
  ansible.builtin.lineinfile:
      path: /etc/fstab
      regexp: "^{{ minio_existing_linode_volume_info.volume.filesystem_path }}"
      state: absent

- name: Mini0 | Disk | Format Volume
  become: true
  community.general.filesystem:
      fstype: ext4
      dev: "{{ minio_existing_linode_volume_info.volume.filesystem_path }}"
      force: false
      resizefs: true

# /dev/disk/by-id/<Volume By ID> <Working Directory> ext4 defaults,noatime,nofail 0 2
- name: Mini0 | Disk | Mount Volume
  become: true
  ansible.posix.mount:
      path: "{{ pv_cs_minio_linode_volume_mount_path }}"
      src: "{{ minio_existing_linode_volume_info.volume.filesystem_path }}"
      fstype: ext4
      state: mounted
      boot: true
      opts: defaults,noatime,nofail
      dump: 0
      passno: 2
